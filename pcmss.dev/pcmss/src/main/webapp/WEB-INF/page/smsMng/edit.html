<!DOCTYPE html>
<html>
<head>
    <link href="${G.host}/res/css/bootstrap.min.css?v=3.3.6"
          rel="stylesheet">
    <link href="${G.host}/res/css/font-awesome.min.css?v=4.4.0"
          rel="stylesheet">
    <link href="${G.host}/res/css/animate.css" rel="stylesheet">
    <link href="${G.host}/res/css/style.css?v=4.1.0" rel="stylesheet">

  <!--  <link href="${G.host}/res/css/summernote/summernote.css" rel="stylesheet">
    <link href="${G.host}/res/css/summernote/summernote-bs3.css" rel="stylesheet">-->

    <#include "/WEB-INF/include/resedit.html" />
</head>

<body class="gray-bg">
<div class="wrapper wrapper-content animated fadeInRight">
    <div class="row">
        <div class="col-sm-12">
            <div class="pull-right ibox-toolbars hidefield">
                <button type="button" class="btn btn-primary" onclick="cancel();">返回</button>
            </div>
            <div class="ibox">
                <div class="ibox-content ibox-content-ad" style="margin-top: 25px;">
                    <form id="form" name="form" method="post" action="${G.serverUrl}/save" class="wizard-big addForm" enctype="multipart/form-data" accept="image/jpg, image/png">
                        <div class="row">
                            <div class="col-sm-6 form_ipt_botm">
                                <div class="form-group">
                                    <label class="col-xs-3 lable_top"><span class="span_require">*</span>短信标题</label>
                                    <div class="col-xs-9"><input type="text" id="sms_title" name="sms_title" class="form-control required" /></div>
                                </div>
                            </div>

                            <div class="col-sm-6 form_ipt_botm">
                                <div class="form-group">
                                    <label class="col-xs-3 lable_top"><span class="span_require">*</span>签名名称</label>
                                    <div class="col-xs-9">
                                        <select name="sign_id" class="form-control required select_change"
                                                id="sign_id">
                                        </select>
                                        <div class="col-xs-9" style="margin-bottom: 5px;position: relative;font-size: 10px;">
                                            · 没有需要的签名，马上 <button class="btn btn-default" type="button"  style="padding: 2px 2px;" onclick="addSign()">添加签名</button>
                                        </div>
                                    </div>

                                </div>
                            </div>

                            <div class="col-sm-6 form_ipt_botm" style="width:100%;">
                                <div class="form-group">
                                    <label class="col-xs-2 lable_top" style=" margin-left: -10px;text-align: left;width: 113px;"><span class="span_require">*</span>短信模板</label>
                                    <div class="col-xs-2">
                                        <select name="mould_type" class="input-group form-control form-control-green select_change" style="width: 150px;left: -15px;"
                                                id="mould_type">
                                        </select>
                                    </div>
                                    <div class="col-xs-2">
                                        <select name="mould_id" class="input-group form-control required form-control-green select_change" style="width: 150px"
                                                id="mould_id">
                                        </select>
                                    </div>
                                    <!--<div class="col-xs-6">
                                        <input type="text" id="mould_fields" name="mould_fields" class="form-control required " onkeyup="setMouldFields()" />
                                    </div>-->
                                    <div class="col-xs-9" style="margin-top: 5px;position: relative;font-size: 10px;left: 100px">
                                        <!-- <div class="col-xs-9" style="position: absolute;left: 330px">
                                             · 输入框中出现多个参数时,用“,”分割区分输入。例如：aaa,bbb,ccc
                                         </div>-->
                                        · 没有需要的模板，马上 <button class="btn btn-default" type="button" style="padding: 2px 2px;"  onclick="addMould()">添加模板</button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-6 form_ipt_botm" style="width:100%;">
                                <div class="form-group">
                                    <label class="col-xs-3 lable_top" style="width:115px;"><span class="span_require">*</span>短信内容</label>
                                    <div class="col-xs-9" style="width:89%;">
                                        <textarea style="height:72px;width:100%;resize:none;"  readonly="readonly" class="form-control required" id="mould_content" name="mould_content"></textarea>
                                    </div>
                                </div>
                            </div>

                            <div class="col-sm-6 form_ipt_botm">
                                <div class="form-group">
                                    <label class="col-xs-3 lable_top"><span class="span_require">*</span>短信接受者</label>
                                    <div class="col-xs-9">
                                        <!--<input type="text" id="sms_rec_obj" name="sms_rec_obj"  />-->
                                        <div class="input-group">
                                            <!--<input type="text" style="" id="sms_rec_obj" name="sms_rec_obj"  class="form-control"/>-->
                                            <input type="file" style="display: none" id="prefile" accept=".csv" name="prefile"  onchange="previeFile(this);" />
                                            <input type="text" style=""  id="file_path" name="file_path" class="form-control required"/>
                                            <span class="input-group-btn">
                                                <a roleDO="button" style="" id="upload_button" class="btn btn-default" type="button" onclick="$('#prefile').click();">
                                                    <i class="fa fa-upload"></i>
                                                </a>
                                            </span>
                                        </div>
                                    </div>
                                    <div class="col-xs-9" style="width:80%;left:100px;">
                                       <!-- <label class="radio-inline">
                                            <input type="radio" name="mould_ty" id="mould_ty0" value="0" checked="checked" />
                                            <label for="mould_ty0"></label><span>手动输入</span></label>&nbsp;
                                        <label class="radio-inline">
                                            <input type="radio" name="mould_ty" id="mould_ty1" value="1" checked="checked"/>
                                            <label for="mould_ty1"></label><span>文件导入</span></label>-->
                                        <div class="col-xs-9" style="margin-bottom: 5px;position: relative;font-size: 10px;width: 500px;left: -50px;">
                                            <ul>
                                                <li>· 请上传xlsx格式，“变量模版”号码文件<button id ="bt" class="btn btn-default" style="padding: 2px 2px;" type="button"><a id ="dt" style="font-size: 12px;">模板下载</a></button>，什么是变量模板</li>
                                                <li>· 请保持导入文件的变量顺序与模版内容的变量顺序一致，请严格遵守范例样式</li>
                                                <li>· 文件大小不可超过3M，建议单次导入号码50万个以内</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="col-sm-6 ediefield">
                                <div class="form-group">
                                    <label class="col-xs-3 lable_top"></label>
                                    <div class="col-xs-9">
                                        <input type="hidden" id="sms_id" name="sms_id" />
                                        <!--<input type="hidden" id="sms_author" name="sms_author" value="${sms_author}"/>-->
                                        <input type="hidden" id="sms_state" name="sms_state" value="1"/>
                                        <input type="hidden" id="sign_name" name="sign_name" />
                                        <input id="submit-form" type="button" class="btn btn-primary" value="发送" onclick="return thingOver();">
                                        <!--<input id="send-form" type="button" class="btn btn-primary" value="发送" onclick="return thingSend();">-->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

    </div>
</div>

</body>

<!-- SUMMERNOTE
<script src="${G.host}/res/js/summernote/summernote.min.js"></script>
<script src="${G.host}/res/js/summernote/summernote-zh-CN.js"></script>
 -->


<script>
    quick.baseUrl = "${G.host}";
    var pdir = "${tpldir}";
    var href = quick.baseUrl+pdir ;
    $('#dt').attr('href',href);


    function config() {
        quick.serverUrl = "${G.serverUrl}";
        quick.objName = "${G.objName}";
        quick.idField = "${G.idField}";
        quick.listUrl = quick.serverUrl + "/list";
    }



    window.onload = function() {
        selectSignNameData();
        selectMouldNameData();
        selectMouldContentData("");

        /*自定义错误提示信息的方法*/
        $("#form").validate({
            errorPlacement: function(error, element) {
                element.parent().append(error);
            },
            ignore : ":disabled",
            rules: {
            }
        });
        /*加载数据*/
        var mode = $.request.queryString["mode"];
        var sysid=$.request.queryString["sms_id"];
        if(sysid){
            $.post(quick.serverUrl + '/getObj?sms_id=' + sysid + "&i=" + Math.random(), function(data){
               // setForm(data);
                $("#sms_id").val(data.sms_id);
                $("#sms_title").val(data.sms_title);
                $("#sms_state").val(data.sms_state);
                $("#sign_id").val(data.sign_id);
                $("#mould_content").val(data.mould_content);
                $("#mould_type").val(data.mould_type);
                selectMouldContentData($("#mould_type").val());
                $("#mould_id").val(data.mould_id);
                $("#file_path").val(data.file_path);
                if(mode == "browse"){
                    viewRead();
                }
            });
        }

    }
    /*完成*/
    var isdone = true;
    var phFileNum = 0; //总数
    var phFiltNum = 0; //过滤重复数
    function thingOver(){
        var mode = $.request.queryString["mode"];
        if(mode == "browse"){
           $('#form').ajaxSubmit(function() {
                layer.msg('保存成功',{icon:1,time: 1500,skin: 'layer-ext-moon'}, function(){
                    cancel();
                });
                isdone = true;
            });
        }else{
            if(!isdone) {
                return false;
            }
            isdone = false;
            if(!$("#form").valid()){
                isdone = true;
                return false;
            }
            var p = $("#file_path").val();
            if(p ==null ||p.length ==0){
                layer.msg('上传文件不能空',{icon:1,time: 1500,skin: 'layer-ext-moon'})
                isdone = true;
                return false;
            }

            clearPlaceHodler();

            var str =
                '<div class="form-group" style="margin-top: 20px">'+
                '<label class="col-xs-3" style="font-size:12px;color:#888;font-weight:normal;font-family:Verdana,Arial;line-height:1.5;white-space: nowrap;" >模板内容</label>'+
                '<div class="col-xs-9">'+
                '<textarea style="height:99px;font-size:13px;width:100%;resize:none;"  readonly="readonly" class="form-control">'+$("#mould_content").val()+'</textarea>'+
                '<label class="col-xs-3 " style="font-size:12px;color:#f00;font-weight:normal;font-family:Verdana,Arial;line-height:1.5;white-space: nowrap;">(模板内容预览)</label>'+
                '</div>'+
                '</div><br>'+
                '<div class="form-group" style="margin-top: 126px;">'+
                '<label class="col-xs-3 " style="font-size:12px;color:#888;font-weight:normal;font-family:Verdana,Arial;line-height:1.5;white-space: nowrap;">发送用户数</label>'+
                '<div class="col-xs-9" style="margin-top: -12px;">' +
                '<span style="font-size:12px;font-weight:normal;font-family:Verdana,Arial;line-height:1.5;white-space: nowrap;color:#f00;">'+phFileNum+'</span></div>'+
                '<div class="col-xs-9">' +
                '<span style="font-size:12px;font-weight:normal;font-family:Verdana,Arial;line-height:1.5;white-space: nowrap;color:#f00;">'+phFiltNum+'</span></div>'+
                '<div class="col-xs-9">' +
                '<span style="font-size:12px;font-weight:normal;font-family:Verdana,Arial;line-height:1.5;white-space: nowrap;color:#f00;margin-left: 78px;">（若出现重复号码时将会重复发送多条短信）</span></div>'+
                '</div><br/>';
            layer.open({
                type: 1,
                title: "<label>短信发送</label>",
                fix: false,
                shadeClose: false,
                maxmin: true,
                zIndex: layer.zIndex,
                area: ['343px', '332px'],/*宽，高*/
                content:str,
                btn:['确定发送','取消发送'],
                yes:function(){
                   $('#form').ajaxSubmit(function() {
                        layer.msg('保存成功',{icon:1,time: 1500,skin: 'layer-ext-moon'}, function(){
                            cancel();
                        });
                        isdone = true;
                    });
                }
            })
            isdone = true;
        }

    }
    //模板信息
    function addMould(){
        alert(quick.baseUrl);
        navAppend("模板信息");/*获取父页面元素并动态赋值父页面title*/
        window.location.href=quick.baseUrl + "/smsMouldMng/list";//跳转到另一个页面，并且还在当前框架
    }
    //签名信息
    function addSign(){
        navAppend("签名信息");/*获取父页面元素并动态赋值父页面title*/
        window.location.href=quick.baseUrl + "/smsSignMng/list";//跳转到另一个页面，并且还在当前框架
    }
    function thingSend(){
        if(!isdone) {
            return false;
        }
        isdone = false;
        if(!$("#form").valid()){
            isdone = true;
            return false;
        }
        clearPlaceHodler();
        $.ajax({
            type: "get",
            url: quick.baseUrl + "/smsMng/sendData",
            async: false,
            dataType: "json",
            success: function (data) {
                layer.msg('发送成功',{icon:1,time: 1500,skin: 'layer-ext-moon'}, function(){
                    cancel();
                });
            }
        });
    }


    function cancel(){
        var url = quick.listUrl + urlDel(location.search, 'mode','sms_id') + '&RFlag=1';
        window.location.href = url;
    }
    function selectSignNameData() {
        $.ajax({
            type: "get",
            url: quick.baseUrl + "/smsMng/getSignNameData",
            async: false,
            dataType: "json",
            success: function (data) {
                $("#sign_id").append("<option selected hidden value=''>选择签名名称</option><option value= ''>选择签名名称</option>");
                for (var i = 0; i < data.rows.length; i++) {
                    var item = data.rows[i];
                    $("#sign_id").append("<option  value=" + item.sign_id + "> " + item.sign_name + "</option>");
                }
            }
        });
    }
    var mouldContentArry = new Array();
    function selectMouldContentData(mould_type) {
        $("#mould_id").empty();
        //$("#mould_fields").empty();
        $.ajax({
            type: "get",
            url: quick.baseUrl + "/smsMouldMng/getMouldTypeContent?mould_type="+mould_type,
            async: false,
            dataType: "json",
            success: function (data) {
                //("<option selected hidden value=''>选择签名名称</option><option value= ''>选择签名名称</option>")
                mouldContentArry = data.rows;
                $("#mould_id").append("<option  selected hidden value=''>选择模板</option><option value= ''>选择模板</option>");
                for (var i = 0; i < data.rows.length; i++) {
                    var item = data.rows[i];
                    $("#mould_id").append("<option  value=" + item.mould_id + "> " + item.mould_name + "</option>");
                }
            }
        });
    }


    function selectMouldNameData() {
        //getMouldTypeData
        $.ajax({
            type: "get",
            url: quick.baseUrl + "/smsMouldMng/getMouldTypeData",
            async: false,
            dataType: "json",
            success: function (data) {
                $("#mould_type").append("<option selected hidden value=''>全部</option><option value= ''>全部</option>");
                for (var i = 0; i < data.rows.length; i++) {
                    var item = data.rows[i];
                    $("#mould_type").append("<option  value=" + item.mould_type + ">" + item.mould_name + "</option>");
                }
            }
        });

    }

    $("#mould_type").change(function(){
        var options=$("#mould_type option:selected");
        var mould_type = options.val();
        selectMouldContentData(mould_type);
    });

    $("#mould_id").change(function(){
        var options=$("#mould_id option:selected");
        var mould_id = options.val();
       var mouldArry = mouldContentArry.filter(function(p){
           return p.mould_id == mould_id;
       });
       $("#mould_content").val(mouldArry == null ?" ":mouldArry[0].mould_content);
       // setMouldFields();
    });


    function setMouldFields(){
        var mould_content = $("#mould_id").val();
        $("#mould_content").val(mould_content);
        // $("#sms_content").val(content);
        //var reg = /\$\{+[a-zA-Z]+}/g;
        // var s= mould_content.match(reg);
        //var s= mould_content.replace(reg, 12)
       // var mould_fields=$("#mould_fields").val().split(",");
        //var newStr=mould_content == null?"" : mould_content.replace(reg,'Fieldsname=');
       // var newArr=newStr.split('Fieldsname=');
        //var html='';
       /* for(var i=0;i<newArr.length;i++){
            if (i == newArr.length - 1){
                html+=newArr[i];
            }else{
                html+=newArr[i]+mould_fields[i];
            }

        }*/
        //$("#sms_content").val(html);

    }
    /*$(':radio').click(function (){
        var val=$('input:radio[name="mould_ty"]:checked').val();
        if(val==0){
            //$("#upload_button").hide();
           // $("#sms_rec_obj").show();
            //$("#file_path").hide();
        }
        if(val==1)
        {
            //$("#upload_button").show();
            //$("#sms_rec_obj").hide();
            //$("#file_path").show();

        }
    });*/
    function previeFile(f){
        if (f.files && f.files[0]){
            var file_obj = f.files[0];
            var fd = new FormData();
            fd.set('file_path', file_obj);
           // $("#file_path").val('').attr("placeholder", f.files[0].name);
            $("#file_path").val(f.files[0].name);
        $.ajax({
                url:quick.baseUrl + "/smsMng/uploadFileAnaly/",
                type:'POST',
                data:fd,
                processData:false,  //tell jQuery not to process the data
                contentType: false,  //tell jQuery not to set contentType
                //这儿的三个参数其实就是XMLHttpRequest里面带的信息。
                success:function (data) {
                    phFileNum = "总号码数为:" + data.filePhCnt ;
                    phFiltNum = "过滤重复后的号码数:" + data.filtPhCnt ;
                }

            })
        }
    }


</script>
</html>